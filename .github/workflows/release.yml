name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    name: Build (aarch64-apple-darwin)
    runs-on: macos-14
    env:
      TARGET: aarch64-apple-darwin

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9 # v1
        with:
          toolchain: stable
          targets: ${{ env.TARGET }}

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
        with:
          shared-key: release-${{ runner.os }}-${{ env.TARGET }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Build
        run: cargo build --locked --release --target "${{ env.TARGET }}"

      - name: Package archive
        shell: bash
        run: |
          set -euo pipefail
          pkg_dir="get-${TARGET}"
          mkdir "$pkg_dir"
          cp "target/${TARGET}/release/get" "$pkg_dir/get"
          chmod +x "$pkg_dir/get"
          tar -cJf "${pkg_dir}.tar.xz" "$pkg_dir"
          shasum -a 256 "${pkg_dir}.tar.xz" > "${pkg_dir}.sha256"

      - name: Upload build artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: release-${{ env.TARGET }}
          path: |
            get-${{ env.TARGET }}.tar.xz
            get-${{ env.TARGET }}.sha256

  release:
    name: Publish GitHub Release
    needs: build
    runs-on: ubuntu-24.04

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: release-aarch64-apple-darwin
          path: dist

      - name: Create checksum manifest
        run: |
          set -euo pipefail
          cat dist/get-*.sha256 | sort > dist/sha256.sum

      - name: Create or update GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if gh release view "${GITHUB_REF_NAME}" >/dev/null 2>&1; then
            gh release upload "${GITHUB_REF_NAME}" dist/get-*.tar.xz dist/sha256.sum --clobber
            exit 0
          fi

          prerelease_flag=()
          if [[ "${GITHUB_REF_NAME}" == *-* ]]; then
            prerelease_flag+=(--prerelease)
          fi

          gh release create "${GITHUB_REF_NAME}" \
            --target "${GITHUB_SHA}" \
            --generate-notes \
            "${prerelease_flag[@]}" \
            dist/get-*.tar.xz \
            dist/sha256.sum
